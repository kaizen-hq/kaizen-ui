@typeparam TItem where TItem : class
@using System.Diagnostics.CodeAnalysis

@if (_isEditMode)
{
    @EditTemplate(_itemCopy)
    <div class="actions">
        <button @onclick="Save">
            <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-save"><path d="M15.2 3a2 2 0 0 1 1.4.6l3.8 3.8a2 2 0 0 1 .6 1.4V19a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2z"/><path d="M17 21v-7a1 1 0 0 0-1-1H8a1 1 0 0 0-1 1v7"/><path d="M7 3v4a1 1 0 0 0 1 1h7"/></svg>
        </button>
        <button @onclick="CancelEditMode">
            <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-x"><path d="M18 6 6 18"/><path d="m6 6 12 12"/></svg>
        </button>
    </div>
}
else
{
    @ReadTemplate
    <div class="actions">
        <button @onclick="StartEditMode">
            <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-pencil"><path d="M21.174 6.812a1 1 0 0 0-3.986-3.987L3.842 16.174a2 2 0 0 0-.5.83l-1.321 4.352a.5.5 0 0 0 .623.622l4.353-1.32a2 2 0 0 0 .83-.497z"/><path d="m15 5 4 4"/></svg>
        </button>
        <button @onclick="Delete">
            <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-trash-2"><path d="M3 6h18"/><path d="M19 6v14c0 1-1 2-2 2H7c-1 0-2-1-2-2V6"/><path d="M8 6V4c0-1 1-2 2-2h4c1 0 2 1 2 2v2"/><line x1="10" x2="10" y1="11" y2="17"/><line x1="14" x2="14" y1="11" y2="17"/></svg>
        </button>
    </div>
}

@code {
    
    [Parameter]
    [NotNull]
    public RenderFragment? ReadTemplate { get; set; }
    
    [Parameter]
    [NotNull]
    public RenderFragment<TItem>? EditTemplate { get; set; }
    
    [Parameter]
    public EventCallback<OnActionCompletedArgs<TItem>> OnActionCompleted { get; set; }
    
    [Parameter]
    [NotNull]
    public TItem? Item { get; set; }
    
    [CascadingParameter]
    [NotNull]
    public EditContext? EditContext { get; set; }

    private TItem _itemCopy = default!;
    
    bool _isEditMode;
    private void StartEditMode()
    {
        var memberwiseClone = typeof(object).GetMethod("MemberwiseClone",
            System.Reflection.BindingFlags.Instance | System.Reflection.BindingFlags.NonPublic);

        // This should never fail, so I'm going to let it fly for now.
        _itemCopy = (TItem)memberwiseClone!.Invoke(Item, null)!;
        _isEditMode = true;
        
        EditContext = new EditContext(_itemCopy);
    }
    
    private void CancelEditMode()
    {
        _isEditMode = false;
    }
    
    private async Task Delete()
    {
        await OnActionCompleted.InvokeAsync(new OnActionCompletedArgs<TItem>(ActionType.Delete, _itemCopy));
    }
    
    private async Task Save()
    {
        await OnActionCompleted.InvokeAsync(new OnActionCompletedArgs<TItem>(ActionType.Save, _itemCopy));
        _isEditMode = false;
    }
}