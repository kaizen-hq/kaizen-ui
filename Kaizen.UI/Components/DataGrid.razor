@typeparam TItem where TItem : class
@attribute [CascadingTypeParameter(nameof(TItem))]
@using System.Diagnostics.CodeAnalysis
@using System.Linq.Expressions
@using System.Text

<div class="santa-grid @(IsGrouped ? "grouped" : "")">
    <div class="header">
        <CascadingValue Value="OrderByState">
            @Header
        </CascadingValue>
    </div>
    <EditForm EditContext="_editContext">
        <DataAnnotationsValidator />
        @if (IsGrouped) 
        {
            @foreach (var group in Query.GroupBy(GroupBy!))
            {
                <div class="group">
                    <ExpandableRow Title="@group.Key">
                        @foreach(var item in group)
                        {
                            <div class="@GetRowCssClass(item)">
                                @RowTemplate(item)
                            </div>
                        }
                    </ExpandableRow>
                </div>
            }
        }
        else
        {
            @foreach (var item in Query)
            {
                <div class="@GetRowCssClass(item)">
                    @RowTemplate(item)
                </div>
            }
        }
    </EditForm>
</div>

@code {

    [Parameter]
    [NotNull]
    public IEnumerable<TItem>? Items { get; set; }

    [Parameter]
    public RenderFragment? Header { get; set; }

    [Parameter]
    [NotNull]
    public RenderFragment<TItem>? RowTemplate { get; set; }

    [Parameter]
    public Paginator.PaginationState? Pagination { get; set; }

    [Parameter]
    public Func<TItem, string> RowCssClass { get; set; } = (item) => "";
    
    [Parameter]
    public Func<TItem, string>? GroupBy { get; set; }

    private OrderByState<TItem, dynamic> OrderByState { get; } = new();
    private EditContext? _editContext;
    private bool IsGrouped => GroupBy is not null;

    IEnumerable<TItem> Query => Pagination is null 
        ? GetSorted() 
        : GetSorted().Skip((Pagination.PageNumber) * Pagination.PageSize).Take(Pagination.PageSize);

    private string GetRowCssClass(TItem item)
    {
        var classes = new List<string>();
        classes.Add("item");
        if (!string.IsNullOrEmpty(RowCssClass(item)))
            classes.Add(RowCssClass(item));
        return string.Join(" ", classes);
    }

    private IEnumerable<TItem> GetSorted()
    {
        if (!OrderByState.OrderBy.Any()) return Items;
        var first = OrderByState.OrderBy.First();
        var orderedQuery = first.Descending ?
            Items.OrderByDescending(first.SortFunc.Compile()) :
            Items.OrderBy(first.SortFunc.Compile());

        foreach (var orderBy in OrderByState.OrderBy.Skip(1))
        {
            orderedQuery = orderBy.Descending ?
                orderedQuery.ThenByDescending(orderBy.SortFunc.Compile()) :
                orderedQuery.ThenBy(orderBy.SortFunc.Compile());
        }
        return orderedQuery;
    }


    protected override void OnInitialized()
    {
        if (Pagination is not null)
        {
            Pagination.OnPageChange += (state) =>
            {
                Pagination = state;
                StateHasChanged();
            };
            Pagination.NumberOfPages = (int)Math.Ceiling((decimal)(Items!.Count() / Pagination.PageSize));
            Pagination.TotalItems = Items?.Count() ?? 0;
            Pagination.Notify();
        }

        OrderByState.UpdateOrderBy = (orderBy, remove) =>
        {
            OrderByState.OrderBy.RemoveAll(x => x.Name == orderBy.Name);
            if (!remove)
                OrderByState.OrderBy.Add(orderBy);
            StateHasChanged();
        };
        _editContext = new EditContext(new {});
        _editContext.OnFieldChanged += (sender, args) => Console.WriteLine($"Field changed! {args.FieldIdentifier.Model}");
    }

    protected override void OnParametersSet()
    {
        if (Pagination is not null)
        {
            Pagination.NumberOfPages = (int)Math.Ceiling((decimal)(Items!.Count() / Pagination.PageSize));
            Pagination.TotalItems = Items?.Count() ?? 0;
            Pagination.Notify();
        }
    }

}
